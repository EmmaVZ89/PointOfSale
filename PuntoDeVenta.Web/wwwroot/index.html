<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Punto de Venta</title>
    <base href="/" />

    <!-- Google Fonts - Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous" />
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
          integrity="sha384-XGjxtQfXaH2tnPFa9x+ruJTuLE3Aa6LhHSWRr1XeTyhezb4abCG4ccI5AkVDxqC+" crossorigin="anonymous" />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/app.css" />
    <link rel="icon" type="image/png" href="favicon.png" />
    <link href="PuntoDeVenta.Web.styles.css" rel="stylesheet" />

    <!-- ApexCharts -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

    <!-- SheetJS para exportar a Excel -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>

<body>
    <div id="app">
        <div class="loading-container">
            <svg class="loading-progress">
                <circle r="40%" cx="50%" cy="50%" />
                <circle r="40%" cx="50%" cy="50%" />
            </svg>
            <div class="loading-progress-text"></div>
        </div>
    </div>

    <div id="blazor-error-ui">
        Ha ocurrido un error inesperado.
        <a href="" class="reload">Recargar</a>
        <a class="dismiss">X</a>
    </div>

    <!-- Bootstrap 5 JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    <script src="_framework/blazor.webassembly.js"></script>
    <!-- Blazored.Toast JS - usando archivo local o CDN como fallback -->
    <script src="_content/Blazored.Toast/blazored-toast.js" onerror="this.src='https://cdn.jsdelivr.net/npm/blazored-toast@4.2.1/content/blazored-toast.js'"></script>

    <!-- Custom JS Interop Functions -->
    <script>
        // Download file from base64 content
        window.downloadFile = function (fileName, base64Content, contentType) {
            const link = document.createElement('a');
            link.href = 'data:' + contentType + ';base64,' + base64Content;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        // Print HTML content in new window
        window.printContent = function (htmlContent, title) {
            const printWindow = window.open('', '_blank', 'width=800,height=600');
            printWindow.document.write(htmlContent);
            printWindow.document.title = title;
            printWindow.document.close();
            printWindow.focus();
            setTimeout(function () {
                printWindow.print();
            }, 250);
        };

        // Open PDF blob in new tab for viewing/printing
        window.openPdfInNewTab = function (base64Content) {
            const byteCharacters = atob(base64Content);
            const byteNumbers = new Array(byteCharacters.length);
            for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
            const byteArray = new Uint8Array(byteNumbers);
            const blob = new Blob([byteArray], { type: 'application/pdf' });
            const blobUrl = URL.createObjectURL(blob);
            window.open(blobUrl, '_blank');
        };

        // Download PDF file
        window.downloadPdfFile = function (base64Content, fileName) {
            const byteCharacters = atob(base64Content);
            const byteNumbers = new Array(byteCharacters.length);
            for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
            const byteArray = new Uint8Array(byteNumbers);
            const blob = new Blob([byteArray], { type: 'application/pdf' });
            const blobUrl = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = blobUrl;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(blobUrl);
        };

        // Export to Excel (.xlsx) with proper number formatting
        // data: array of arrays (first row is header)
        // fileName: name of the file without extension
        // columnTypes: optional array indicating column types ('text', 'number', 'currency', 'date')
        window.exportToExcel = function (data, fileName, columnTypes) {
            if (typeof XLSX === 'undefined') {
                console.error('SheetJS library not loaded');
                return;
            }

            // Create workbook and worksheet
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(data);

            // Apply column widths based on content
            const colWidths = [];
            for (let c = 0; c < data[0].length; c++) {
                let maxWidth = 10;
                for (let r = 0; r < data.length; r++) {
                    const cellValue = data[r][c];
                    if (cellValue !== null && cellValue !== undefined) {
                        const cellLength = String(cellValue).length;
                        if (cellLength > maxWidth) {
                            maxWidth = Math.min(cellLength + 2, 50);
                        }
                    }
                }
                colWidths.push({ wch: maxWidth });
            }
            ws['!cols'] = colWidths;

            // Apply number formats if columnTypes provided
            if (columnTypes && columnTypes.length > 0) {
                const range = XLSX.utils.decode_range(ws['!ref']);
                for (let R = range.s.r + 1; R <= range.e.r; ++R) { // Skip header row
                    for (let C = range.s.c; C <= range.e.c; ++C) {
                        const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
                        const cell = ws[cellAddress];
                        if (cell && columnTypes[C]) {
                            switch (columnTypes[C]) {
                                case 'currency':
                                    cell.z = '"$"#.##0,00'; // Argentine currency format
                                    break;
                                case 'number':
                                    cell.z = '#.##0,00'; // Argentine number format
                                    break;
                                case 'integer':
                                    cell.z = '#.##0'; // Argentine integer format
                                    break;
                                case 'date':
                                    cell.z = 'dd/mm/yyyy';
                                    break;
                            }
                        }
                    }
                }
            }

            // Add worksheet to workbook
            XLSX.utils.book_append_sheet(wb, ws, 'Reporte');

            // Generate and download file
            XLSX.writeFile(wb, fileName + '.xlsx');
        };
    </script>
</body>

</html>
