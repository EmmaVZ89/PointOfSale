@page "/caja"
@attribute [Authorize]
@using PuntoDeVenta.Web.Services
@inject IVentaService VentaService
@inject IToastService ToastService
@inject IJSRuntime JS
@inject NavigationManager Navigation

<PageTitle>Caja - Gestión POS</PageTitle>

<PageHeader Title="Caja" Subtitle="Ventas, tickets y movimientos" />

<!-- Selector de Fecha -->
<div class="card mb-4 border-0 shadow-sm">
    <div class="card-body">
        <div class="row g-3 align-items-center">
            <div class="col-auto">
                <label class="col-form-label fw-bold">
                    <i class="bi bi-calendar3 me-2"></i>Fecha de Caja:
                </label>
            </div>
            <div class="col-auto">
                <input type="date" class="form-control" @bind="fechaSeleccionada" @bind:after="OnFechaChanged" />
            </div>
            <div class="col-auto">
                <div class="btn-group btn-group-sm">
                    <button class="btn @(EsHoy() ? "btn-primary" : "btn-outline-secondary")" @onclick="IrAHoy">
                        Hoy
                    </button>
                    <button class="btn btn-outline-secondary" @onclick="DiaSiguiente" disabled="@EsHoy()">
                        <i class="bi bi-chevron-right"></i>
                    </button>
                    <button class="btn btn-outline-secondary" @onclick="DiaAnterior">
                        <i class="bi bi-chevron-left"></i>
                    </button>
                </div>
            </div>
            <div class="col">
                <span class="badge bg-secondary fs-6">
                    @fechaSeleccionada.ToString("dddd, dd 'de' MMMM 'de' yyyy", new System.Globalization.CultureInfo("es-ES"))
                </span>
                @if (EsHoy())
                {
                    <span class="badge bg-success ms-2">HOY</span>
                }
            </div>
            <AuthorizeView Roles="Admin">
                <Authorized>
                    <div class="col-auto ms-auto">
                        <button class="btn btn-outline-primary" @onclick="DescargarReporteCaja" disabled="@isDownloading">
                            @if (isDownloading)
                            {
                                <span class="spinner-border spinner-border-sm me-1"></span>
                            }
                            else
                            {
                                <i class="bi bi-file-earmark-pdf me-1"></i>
                            }
                            Descargar Reporte
                        </button>
                    </div>
                </Authorized>
            </AuthorizeView>
        </div>
    </div>
</div>

<!-- KPIs -->
<div class="row g-3 mb-4">
    <div class="col-12 col-sm-6 col-lg-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-shrink-0">
                        <div class="bg-primary bg-opacity-10 rounded-3 p-3">
                            <i class="bi bi-receipt text-primary fs-4"></i>
                        </div>
                    </div>
                    <div class="flex-grow-1 ms-3 overflow-hidden">
                        <h6 class="text-muted mb-1 small">Ventas</h6>
                        <div class="kpi-value-responsive">@ventasCaja.Count</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <AuthorizeView Roles="Admin">
        <Authorized>
            <div class="col-12 col-sm-6 col-lg-3">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0">
                                <div class="bg-success bg-opacity-10 rounded-3 p-3">
                                    <i class="bi bi-cash-stack text-success fs-4"></i>
                                </div>
                            </div>
                            <div class="flex-grow-1 ms-3 overflow-hidden">
                                <h6 class="text-muted mb-1 small">Ingresos</h6>
                                <div class="kpi-value-currency text-success">@FormatHelper.FormatCurrencyNoDecimals(ventasCaja.Where(v => v.Estado != "CANCELADA").Sum(v => v.Total))</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-12 col-sm-6 col-lg-3">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0">
                                <div class="bg-info bg-opacity-10 rounded-3 p-3">
                                    <i class="bi bi-calculator text-info fs-4"></i>
                                </div>
                            </div>
                            <div class="flex-grow-1 ms-3 overflow-hidden">
                                <h6 class="text-muted mb-1 small">Ticket Promedio</h6>
                                <div class="kpi-value-currency text-info">@(ventasCaja.Where(v => v.Estado != "CANCELADA").Any() ? FormatHelper.FormatCurrencyNoDecimals(ventasCaja.Where(v => v.Estado != "CANCELADA").Average(v => v.Total)) : "$0")</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </Authorized>
    </AuthorizeView>
    <div class="col-12 col-sm-6 col-lg-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-shrink-0">
                        <div class="bg-danger bg-opacity-10 rounded-3 p-3">
                            <i class="bi bi-x-circle text-danger fs-4"></i>
                        </div>
                    </div>
                    <div class="flex-grow-1 ms-3 overflow-hidden">
                        <h6 class="text-muted mb-1 small">Canceladas</h6>
                        <div class="kpi-value-responsive text-danger">@ventasCaja.Count(v => v.Estado == "CANCELADA")</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Filtros y acciones -->
<div class="card mb-4 border-0 shadow-sm">
    <div class="card-body">
        <div class="row g-3 align-items-end">
            <div class="col-12 col-md-4">
                <label class="form-label">Buscar</label>
                <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input type="text" class="form-control" placeholder="No. Factura, Cliente..."
                           @bind="filtro" @bind:event="oninput" @onkeyup="FiltrarVentas" />
                </div>
            </div>
            <div class="col-6 col-md-2">
                <label class="form-label">Estado</label>
                <select class="form-select" @bind="filtroEstado" @bind:after="FiltrarVentas">
                    <option value="">Todas</option>
                    <option value="COMPLETADA">Completadas</option>
                    <option value="CANCELADA">Canceladas</option>
                </select>
            </div>
            <div class="col-6 col-md-3">
                <button class="btn btn-outline-primary w-100" @onclick="RefreshVentas">
                    <i class="bi bi-arrow-clockwise me-1"></i>
                    Actualizar
                </button>
            </div>
            <div class="col-12 col-md-3">
                <button class="btn btn-success w-100" @onclick="IrAPOS">
                    <i class="bi bi-cart-plus me-1"></i>
                    Nueva Venta
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Listado de ventas -->
@if (isLoading)
{
    <LoadingSpinner IsLoading="true" />
}
else if (ventasFiltradas.Any())
{
    <div class="card border-0 shadow-sm">
        <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
            <span>
                <i class="bi bi-list-ul me-2"></i>
                Ventas del @fechaSeleccionada.ToString("dd/MM/yyyy")
            </span>
            <span class="badge bg-primary">@ventasFiltradas.Count ventas</span>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover table-to-cards mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Hora</th>
                            <th>Factura</th>
                            <th>Cliente</th>
                            <th class="text-end">Total</th>
                            <th>Pago</th>
                            <th>Estado</th>
                            <th class="text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var venta in ventasFiltradas.OrderByDescending(v => v.Fecha))
                        {
                            <tr class="@(venta.Estado == "CANCELADA" ? "table-danger" : "")">
                                <td data-label="Hora">
                                    <i class="bi bi-clock me-1 text-muted"></i>
                                    @venta.Fecha.ToString("HH:mm")
                                </td>
                                <td data-label="Factura">
                                    <code class="fw-bold">@venta.NoFactura</code>
                                </td>
                                <td data-label="Cliente">
                                    @(venta.ClienteNombre ?? "Consumidor Final")
                                </td>
                                <td data-label="Total" class="text-end fw-bold">
                                    @FormatHelper.FormatCurrencyNoDecimals(venta.Total)
                                </td>
                                <td data-label="Pago">
                                    <span class="badge @(venta.FormaPago == "T" ? "bg-info" : "bg-warning text-dark")">
                                        <i class="bi @(venta.FormaPago == "T" ? "bi-bank" : "bi-cash") me-1"></i>
                                        @(venta.FormaPago == "T" ? "Transferencia" : "Efectivo")
                                    </span>
                                </td>
                                <td data-label="Estado">
                                    <span class="badge @(venta.Estado == "COMPLETADA" ? "bg-success" : "bg-danger")">
                                        <i class="bi @(venta.Estado == "COMPLETADA" ? "bi-check-circle" : "bi-x-circle") me-1"></i>
                                        @venta.Estado
                                    </span>
                                </td>
                                <td data-label="Acciones" class="text-center">
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-primary" title="Ver Detalle"
                                                @onclick="() => VerDetalle(venta)">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                        <button class="btn btn-outline-secondary" title="Reimprimir Ticket"
                                                @onclick="() => ReimprimirTicket(venta)">
                                            <i class="bi bi-printer"></i>
                                        </button>
                                        @if (venta.Estado != "CANCELADA")
                                        {
                                            <AuthorizeView Roles="Admin">
                                                <Authorized>
                                                    <button class="btn btn-outline-danger" title="Cancelar Venta"
                                                            @onclick="() => MostrarModalCancelar(venta)">
                                                        <i class="bi bi-x-lg"></i>
                                                    </button>
                                                </Authorized>
                                            </AuthorizeView>
                                        }
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
}
else
{
    <EmptyState Title="Sin ventas"
                Message="@($"No hay ventas registradas el {fechaSeleccionada:dd/MM/yyyy}.")"
                IconClass="bi-cart-x" />
}

<!-- Modal Ver Detalle -->
@if (showDetalleModal && ventaSeleccionada != null)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-receipt me-2"></i>
                        Detalle de Venta - @ventaSeleccionada.NoFactura
                    </h5>
                    <button type="button" class="btn-close" @onclick="CerrarModales"></button>
                </div>
                <div class="modal-body">
                    <!-- Info de la venta -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <p class="mb-1"><strong>Fecha:</strong> @ventaSeleccionada.Fecha.ToString("dd/MM/yyyy HH:mm")</p>
                            <p class="mb-1"><strong>Cliente:</strong> @(ventaSeleccionada.ClienteNombre ?? "Consumidor Final")</p>
                            <p class="mb-0"><strong>Vendedor:</strong> @ventaSeleccionada.UsuarioNombre</p>
                        </div>
                        <div class="col-md-6 text-md-end">
                            <span class="badge fs-6 @(ventaSeleccionada.Estado == "COMPLETADA" ? "bg-success" : "bg-danger")">
                                @ventaSeleccionada.Estado
                            </span>
                            <span class="badge fs-6 @(ventaSeleccionada.FormaPago == "T" ? "bg-info" : "bg-warning text-dark") ms-1">
                                <i class="bi @(ventaSeleccionada.FormaPago == "T" ? "bi-bank" : "bi-cash") me-1"></i>
                                @(ventaSeleccionada.FormaPago == "T" ? "Transferencia" : "Efectivo")
                            </span>
                        </div>
                    </div>

                    @if (ventaSeleccionada.Estado == "CANCELADA" && !string.IsNullOrEmpty(ventaSeleccionada.MotivoCancelacion))
                    {
                        <div class="alert alert-danger mb-4">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <strong>Motivo de cancelación:</strong> @ventaSeleccionada.MotivoCancelacion
                        </div>
                    }

                    <!-- Detalle de productos -->
                    @if (isLoadingDetalle)
                    {
                        <div class="text-center py-3">
                            <div class="spinner-border text-primary" role="status"></div>
                        </div>
                    }
                    else if (ventaDetalle != null && ventaDetalle.Detalles.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead class="table-light">
                                    <tr>
                                        <th>Producto</th>
                                        <th class="text-center">Cant.</th>
                                        <th class="text-end">Precio</th>
                                        <th class="text-end">Subtotal</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var item in ventaDetalle.Detalles)
                                    {
                                        <tr>
                                            <td>
                                                @item.NombreProducto@if (!string.IsNullOrEmpty(item.PresentacionNombre) && item.CantidadUnidadesPorPresentacion > 1)
                                                {<text> - @item.PresentacionNombre</text>}
                                                <br /><code class="small text-muted">@item.CodigoProducto</code>
                                            </td>
                                            <td class="text-center">@item.Cantidad</td>
                                            <td class="text-end">@FormatHelper.FormatCurrency(item.PrecioUnitario)</td>
                                            <td class="text-end">@FormatHelper.FormatCurrency(item.Subtotal)</td>
                                        </tr>
                                    }
                                </tbody>
                                <tfoot class="table-light">
                                    <tr>
                                        <td colspan="3" class="text-end fw-bold">TOTAL:</td>
                                        <td class="text-end fw-bold fs-5 text-success">@FormatHelper.FormatCurrencyNoDecimals(ventaDetalle.Total)</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline-secondary" @onclick="() => ReimprimirTicket(ventaSeleccionada)">
                        <i class="bi bi-printer me-1"></i>
                        Reimprimir Ticket
                    </button>
                    @if (ventaSeleccionada.Estado != "CANCELADA")
                    {
                        <AuthorizeView Roles="Admin">
                            <Authorized>
                                <button class="btn btn-danger" @onclick="() => MostrarModalCancelar(ventaSeleccionada)">
                                    <i class="bi bi-x-circle me-1"></i>
                                    Cancelar Venta
                                </button>
                            </Authorized>
                        </AuthorizeView>
                    }
                    <button class="btn btn-secondary" @onclick="CerrarModales">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Modal Cancelar Venta -->
@if (showCancelarModal && ventaACancelar != null)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Cancelar Venta
                    </h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="CerrarModales"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning mb-3">
                        <i class="bi bi-info-circle me-2"></i>
                        Esta acción no se puede deshacer. El stock de los productos será restaurado.
                    </div>

                    <p><strong>Factura:</strong> <code>@ventaACancelar.NoFactura</code></p>
                    <p><strong>Total:</strong> @FormatHelper.FormatCurrencyNoDecimals(ventaACancelar.Total)</p>
                    <p><strong>Cliente:</strong> @(ventaACancelar.ClienteNombre ?? "Consumidor Final")</p>

                    <hr />

                    <div class="mb-3">
                        <label class="form-label fw-bold">Motivo de cancelación <span class="text-danger">*</span></label>
                        <textarea class="form-control @(string.IsNullOrWhiteSpace(motivoCancelacion) && intentoCancelar ? "is-invalid" : "")"
                                  rows="3" placeholder="Ingrese el motivo de la cancelación..."
                                  @bind="motivoCancelacion"></textarea>
                        @if (string.IsNullOrWhiteSpace(motivoCancelacion) && intentoCancelar)
                        {
                            <div class="invalid-feedback">El motivo es obligatorio</div>
                        }
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="CerrarModales" disabled="@isCancelling">
                        Volver
                    </button>
                    <button class="btn btn-danger" @onclick="ConfirmarCancelacion" disabled="@isCancelling">
                        @if (isCancelling)
                        {
                            <span class="spinner-border spinner-border-sm me-1"></span>
                        }
                        <i class="bi bi-x-circle me-1"></i>
                        Confirmar Cancelación
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<VentaDTO> ventasCaja = new();
    private List<VentaDTO> ventasFiltradas = new();
    private bool isLoading = true;
    private bool isLoadingDetalle = false;
    private bool isCancelling = false;
    private bool isDownloading = false;

    // Fecha seleccionada
    private DateTime fechaSeleccionada = DateTime.Today;

    // Filtros
    private string filtro = "";
    private string filtroEstado = "";

    // Modales
    private bool showDetalleModal = false;
    private bool showCancelarModal = false;
    private VentaDTO? ventaSeleccionada;
    private VentaDTO? ventaDetalle;
    private VentaDTO? ventaACancelar;
    private string motivoCancelacion = "";
    private bool intentoCancelar = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadVentasCaja();
    }

    // Metodos de navegacion de fecha
    private bool EsHoy() => fechaSeleccionada.Date == DateTime.Today;

    private async Task OnFechaChanged()
    {
        await LoadVentasCaja();
    }

    private async Task IrAHoy()
    {
        fechaSeleccionada = DateTime.Today;
        await LoadVentasCaja();
    }

    private async Task DiaAnterior()
    {
        fechaSeleccionada = fechaSeleccionada.AddDays(-1);
        await LoadVentasCaja();
    }

    private async Task DiaSiguiente()
    {
        if (!EsHoy())
        {
            fechaSeleccionada = fechaSeleccionada.AddDays(1);
            await LoadVentasCaja();
        }
    }

    private async Task LoadVentasCaja()
    {
        isLoading = true;

        try
        {
            var filtroCaja = new VentaFiltroDTO
            {
                FechaDesde = fechaSeleccionada.Date,
                FechaHasta = fechaSeleccionada.Date,
                Page = 1,
                PageSize = 500
            };

            var response = await VentaService.GetAllAsync(filtroCaja);

            if (response.Success && response.Data != null)
            {
                ventasCaja = response.Data.Items;
                FiltrarVentas();
            }
            else
            {
                ventasCaja = new List<VentaDTO>();
                ventasFiltradas = new List<VentaDTO>();
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error al cargar ventas: {ex.Message}");
            ventasCaja = new List<VentaDTO>();
            ventasFiltradas = new List<VentaDTO>();
        }

        isLoading = false;
    }

    private void FiltrarVentas()
    {
        var query = ventasCaja.AsEnumerable();

        if (!string.IsNullOrWhiteSpace(filtro))
        {
            var filtroLower = filtro.ToLower();
            query = query.Where(v =>
                v.NoFactura.ToLower().Contains(filtroLower) ||
                (v.ClienteNombre?.ToLower().Contains(filtroLower) ?? false));
        }

        if (!string.IsNullOrWhiteSpace(filtroEstado))
        {
            query = query.Where(v => v.Estado == filtroEstado);
        }

        ventasFiltradas = query.ToList();
    }

    private async Task RefreshVentas()
    {
        await LoadVentasCaja();
        ToastService.ShowInfo("Ventas actualizadas");
    }

    private void IrAPOS()
    {
        Navigation.NavigateTo("/pos");
    }

    private async Task VerDetalle(VentaDTO venta)
    {
        ventaSeleccionada = venta;
        showDetalleModal = true;
        isLoadingDetalle = true;

        try
        {
            var response = await VentaService.GetByIdAsync(venta.IdVenta);
            if (response.Success && response.Data != null)
            {
                ventaDetalle = response.Data;
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error al cargar detalle: {ex.Message}");
        }

        isLoadingDetalle = false;
    }

    private async Task ReimprimirTicket(VentaDTO venta)
    {
        try
        {
            ToastService.ShowInfo("Generando ticket...");

            var pdfBytes = await VentaService.GetTicketPdfAsync(venta.IdVenta);

            if (pdfBytes != null && pdfBytes.Length > 0)
            {
                var base64 = Convert.ToBase64String(pdfBytes);
                await JS.InvokeVoidAsync("openPdfInNewTab", base64);
                ToastService.ShowSuccess("Ticket generado correctamente");
            }
            else
            {
                ToastService.ShowError("No se pudo generar el ticket");
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error al reimprimir: {ex.Message}");
        }
    }

    private async Task DescargarReporteCaja()
    {
        isDownloading = true;

        try
        {
            ToastService.ShowInfo("Generando reporte de caja...");

            var pdfBytes = await VentaService.GetReporteCajaPdfAsync(fechaSeleccionada);

            if (pdfBytes != null && pdfBytes.Length > 0)
            {
                var base64 = Convert.ToBase64String(pdfBytes);
                var fileName = $"ReporteCaja_{fechaSeleccionada:yyyyMMdd}.pdf";
                await JS.InvokeVoidAsync("downloadPdfFile", base64, fileName);
                ToastService.ShowSuccess("Reporte generado correctamente");
            }
            else
            {
                ToastService.ShowError("No se pudo generar el reporte");
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error al generar reporte: {ex.Message}");
        }
        finally
        {
            isDownloading = false;
        }
    }

    private void MostrarModalCancelar(VentaDTO venta)
    {
        ventaACancelar = venta;
        motivoCancelacion = "";
        intentoCancelar = false;
        showDetalleModal = false;
        showCancelarModal = true;
    }

    private async Task ConfirmarCancelacion()
    {
        intentoCancelar = true;

        if (string.IsNullOrWhiteSpace(motivoCancelacion))
        {
            return;
        }

        if (ventaACancelar == null) return;

        isCancelling = true;

        try
        {
            var response = await VentaService.CancelarAsync(ventaACancelar.IdVenta, motivoCancelacion);

            if (response.Success)
            {
                ToastService.ShowSuccess($"Venta {ventaACancelar.NoFactura} cancelada correctamente");
                CerrarModales();
                await LoadVentasCaja();
            }
            else
            {
                ToastService.ShowError(response.Message ?? "Error al cancelar la venta");
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error: {ex.Message}");
        }

        isCancelling = false;
    }

    private void CerrarModales()
    {
        showDetalleModal = false;
        showCancelarModal = false;
        ventaSeleccionada = null;
        ventaDetalle = null;
        ventaACancelar = null;
        motivoCancelacion = "";
        intentoCancelar = false;
    }
}
